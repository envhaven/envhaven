#!/usr/bin/with-contenv bash

AGENTS_FILE="/config/workspace/AGENTS.md"
CLAUDE_FILE="/config/workspace/CLAUDE.md"

mkdir -p /config/workspace
chown abc:abc /config/workspace

mkdir -p /config/go
chown -R abc:abc /config/go

generate_agents_md() {
    export USER_NAME="abc"
    export WORKSPACE_PATH="/config/workspace"
    
    # Generate base template
    envsubst < /defaults/AGENTS.md.template > "$AGENTS_FILE"
    
    # Append mode-specific section
    if [ "${ENVHAVEN_MANAGED:-false}" = "true" ]; then
        envsubst < /defaults/AGENTS.md.managed.template >> "$AGENTS_FILE"
    else
        envsubst < /defaults/AGENTS.md.selfhosted.template >> "$AGENTS_FILE"
    fi
    
    chown abc:abc "$AGENTS_FILE"
    
    # Create CLAUDE.md copy for Claude Code compatibility
    # (copy instead of symlink - Claude Code may not follow symlinks)
    cp "$AGENTS_FILE" "$CLAUDE_FILE"
    chown abc:abc "$CLAUDE_FILE"
}

generate_agents_md
echo "AGENTS.md generated (managed=${ENVHAVEN_MANAGED:-false})"
echo "CLAUDE.md created (copy of AGENTS.md)"
