# EnvHaven Environment

## Quick Reference

| Property | Value |
|----------|-------|
| **OS** | Ubuntu (Docker container) |
| **User** | `abc` (sudo available) |
| **Shell** | zsh (oh-my-zsh) or bash |
| **Workspace** | `${WORKSPACE_PATH}` |

### Web Servers

**MUST bind to `0.0.0.0`**, not localhost or 127.0.0.1, for apps to be accessible outside the container.

```javascript
// Express
app.listen(3000, '0.0.0.0');

// Next.js (package.json)
"scripts": { "dev": "next dev -H 0.0.0.0" }

// Vite (vite.config.ts)
server: { host: '0.0.0.0' }

// FastAPI
uvicorn main:app --host 0.0.0.0 --port 3000
```

### Package Managers

| Language | Preferred | Command |
|----------|-----------|---------|
| JavaScript | `bun` | `bun install`, `bun add <pkg>` |
| Python | `uv` | `uv pip install`, `uv add <pkg>` |

### Database

Use **SQLite** by default: `sqlite3 myapp.db`

---

## Terminal Sessions (tmux)

EnvHaven uses a **single persistent tmux session** named `envhaven`. This enables:

- **Cross-device continuity**: Same session from browser, SSH, or Haven CLI
- **Process persistence**: Dev servers and AI tools keep running if you disconnect
- **Multi-window workflow**: Run AI tool in one window, dev server in another

### Bottom Bar

The tmux status bar shows:

| Element | Description |
|---------|-------------|
| **Session name** | `envhaven` (left side) |
| **Window list** | Numbered tabs, current highlighted |
| **Version** | EnvHaven version + update indicator |
| **Hotkeys** | Press `Ctrl+B` to see options |

### Hotkeys (after `Ctrl+B`)

| Key | Action |
|-----|--------|
| `n` | New window |
| `x` | Close current pane |
| `0-9` | Switch to window by number |
| `Shift+Click` | Close window (in status bar) |

### Default Behavior

- New terminal sessions auto-attach to the `envhaven` session
- Windows are numbered starting at 1
- Closing last window ends the session (new one created on next terminal open)

### Power User Override

To bypass auto-attach (e.g., for nested tmux):
```bash
ENVHAVEN_SKIP_WELCOME=1 zsh
```

---

## VS Code Extension (Sidebar)

The EnvHaven sidebar (Activity Bar icon) provides:

### Terminals Section

- **Window list**: Shows all tmux windows, click to switch
- **New Terminal**: Creates new tmux window
- **Kill**: Close windows (shift+click in status bar also works)

### AI Tools Section

| Feature | Description |
|---------|-------------|
| **Tool launcher** | One-click launch into new tmux window |
| **Status indicators** | ● ready (authenticated) / ○ needs setup |
| **Setup guides** | Inline instructions for each tool |

### API Key Management

- Secure input fields for each provider's API key
- Auto-saves to `~/.zshrc` and `~/.bashrc`
- Keys available immediately in current session

### SSH Access Section

- **Import from GitHub**: Enter username to fetch `github.com/<user>.keys`
- **Paste key**: Direct input for SSH public key
- **SSH command**: Copy-ready connection string

### Workspace Info

- URLs (public, preview)
- SSH connection details
- Workspace path

---

## Runtimes

| Runtime | Version | Package Manager |
|---------|---------|-----------------|
| **Node.js** | 20.x LTS | npm, pnpm, yarn |
| **Bun** | latest | bun |
| **Python** | 3.12.x | uv, pip |
| **Go** | 1.22.x | go modules |
| **Rust** | stable | cargo |

---

## AI Coding Tools

12 AI coding tools are pre-installed. Most require API keys.

### CLI Tools

| Tool | Command | API Key / Auth |
|------|---------|----------------|
| **OpenCode** | `opencode` | `ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, or `GEMINI_API_KEY` |
| **Claude Code** | `claude` | `ANTHROPIC_API_KEY` or `/login` in CLI |
| **Aider** | `aider` | `ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, `GEMINI_API_KEY`, or `OPENROUTER_API_KEY` |
| **Codex** | `codex` | `OPENAI_API_KEY` or ChatGPT login |
| **Gemini CLI** | `gemini` | `GEMINI_API_KEY` or `GOOGLE_API_KEY` |
| **Goose** | `goose` | `ANTHROPIC_API_KEY` or `OPENAI_API_KEY` (run `goose configure`) |
| **Mistral Vibe** | `vibe` | `MISTRAL_API_KEY` |
| **Qwen Code** | `qwen` | `QWEN_API_KEY` or `OPENAI_API_KEY` (compatible endpoint) |
| **Amp** | `amp` | `AMP_API_KEY` or `amp login` |
| **Augment** | `auggie` | Browser login via `auggie login` |
| **Kiro** | `kiro-cli` | Browser login (GitHub / Google / AWS Builder ID) |
| **Factory Droid** | `droid` | Browser login or `FACTORY_API_KEY` |

### API Key Configuration

Set keys via environment variables or the EnvHaven sidebar:

```bash
export ANTHROPIC_API_KEY=sk-ant-...   # Claude Code, Aider, OpenCode, Goose
export OPENAI_API_KEY=sk-...          # Codex CLI, Aider, Goose, Qwen
export GEMINI_API_KEY=...             # Gemini CLI, Aider, OpenCode
export GOOGLE_API_KEY=...             # Gemini CLI (alternative)
export MISTRAL_API_KEY=...            # Mistral Vibe
export AMP_API_KEY=...                # Amp
export OPENROUTER_API_KEY=...         # Aider (OpenRouter)
export QWEN_API_KEY=...               # Qwen Code
export FACTORY_API_KEY=...            # Factory/Droid
```

Add to `~/.zshrc` or `~/.bashrc` for persistence across sessions.

---

## CLI Tools

| Tool | Command | Purpose |
|------|---------|---------|
| **GitHub CLI** | `gh` | GitHub operations |
| **git** | `git` | Version control |
| **ripgrep** | `rg` | Fast text search |
| **fd** | `fd` | Fast file finder |
| **jq** | `jq` | JSON processor |
| **sqlite3** | `sqlite3` | SQLite CLI |
| **curl** | `curl` | HTTP requests |
| **htop** | `htop` | Process viewer |
| **cloudflared** | `cloudflared` | Cloudflare tunnel CLI |

---

## Running Dev Servers

Use named tmux windows for dev servers. This makes them visible in the sidebar and status bar.

### Naming Convention

| Mode | Window Name | Example |
|------|-------------|---------|
| Development | `{project}-dev` | `myapp-dev` |
| Production | `{project}` | `myapp` |

### Start a Dev Server

```bash
# From project directory
cd ${WORKSPACE_PATH}/myproject

# Create named window (detached) and start server
tmux new-window -d -n "$(basename $(pwd))-dev" -c "$(pwd)" \; \
  send-keys -t "$(basename $(pwd))-dev" 'npm run dev 2>&1 | tee /tmp/$(basename $(pwd))-dev.log' Enter
```

The `-d` flag creates the window without switching to it.

### Check Logs

```bash
tail -f /tmp/myapp-dev.log      # Live follow
tail -100 /tmp/myapp-dev.log    # Last 100 lines
grep -i error /tmp/myapp-dev.log # Search errors
```

---

## Haven CLI

Haven CLI enables using a **local editor** (neovim, emacs, helix, VS Code) on the user's machine while **AI tools run in this container**. Changes sync bidirectionally in ~200ms via Mutagen.

### When to Suggest Haven CLI

- User prefers their local editor configuration
- User wants to use local AI tools but needs EnvHaven's environment
- User is on a slow connection and wants local file editing

### Commands

| Command | Description |
|---------|-------------|
| `haven connect [path] [target]` | Connect local directory to workspace |
| `haven disconnect [path]` | Stop sync and disconnect |
| `haven status` | Show connection status |
| `haven <any-command>` | Run any command in workspace remotely |

### Options

| Option | Description |
|--------|-------------|
| `--idle-timeout <duration>` | Override idle timeout (e.g., `4h`) |
| `--reset-host-key` | Clear cached host key after workspace rebuild |
| `--watch` | Continuously update status |
| `--json` | JSON output |
| `--diagnose` | Run diagnostic checks |

### Remote Execution

Any command not reserved by Haven CLI runs in the workspace:

```bash
haven opencode          # Run OpenCode in workspace
haven npm install       # Install dependencies remotely
haven git status        # Check git status
```

### Sync Details

- **Latency:** ~200ms bidirectional
- **Conflicts:** Creates `.sync-conflict` files when both sides modify same file
- **Custom ignores:** Add `.havenignore` file (gitignore syntax)

### Prerequisites

User must add their SSH public key via:
- **EnvHaven sidebar** (SSH Access section)
- `PUBLIC_KEY_URL` env var (e.g., `https://github.com/username.keys`)
- Manual: add to `~/.ssh/authorized_keys`

---

## Workspace Structure

```
/config/                    # Container home directory
├── workspace/              # Project files (${WORKSPACE_PATH})
│   ├── AGENTS.md           # This file
│   ├── CLAUDE.md           # Copy of AGENTS.md (for Claude Code)
│   └── <projects>/         # User's projects
├── .ssh/                   # SSH keys
│   └── authorized_keys     # For SSH/Haven CLI access
├── .zshrc                  # Shell config (API keys persisted here)
└── .config/                # Tool configurations
```

---

## Quick Start Examples

### Node.js/Bun Project

```bash
mkdir myapp && cd myapp
bun init
bun add express
```

### Python Project

```bash
mkdir myapp && cd myapp
uv init
uv add fastapi uvicorn
```

### Go Project

```bash
mkdir myapp && cd myapp
go mod init myapp
```

---

## CRITICAL: SSH/GPG Key Security Protocol

**You have file access to `~/.ssh/` and `~/.gnupg/`.** So do MCP servers. Unprotected keys let any tool silently push code, sign commits, or SSH into servers. Passphrase-protected keys require human approval for every use.

### MANDATORY: Detect and Warn BEFORE Executing

Scan user messages for these triggers. **STOP and warn before proceeding.**

| Triggers |
|----------|
| `ssh-keygen`, `gpg --gen-key`, `gpg --full-generate-key`, `gpg --import` |
| "generate/create SSH key", "set up SSH", "new SSH key" |
| "GitHub SSH", "GitLab SSH", "authenticate with GitHub", "push access" |
| "GPG key", "PGP key", "commit signing", "sign my commits" |
| Writing to `~/.ssh/`, `~/.gnupg/`, handling `id_rsa`, `id_ed25519`, `.pem`, `.asc` |

**NON-NEGOTIABLE.** Even if user seems experienced. Even if they're in a hurry. ALWAYS warn first.

### Warning To Deliver

Adapt tone, but include ALL points:

> ⚠️ **Security note:** I (and other tools/MCP servers here) can access `~/.ssh/` and `~/.gnupg/`. Without a passphrase, any tool could silently push code, sign commits, or SSH into your servers.
>
> **Use a passphrase** — when `ssh-keygen` prompts, enter one (don't skip). Use `ssh-agent` so you only type it once per session. This keeps you in control even if a tool misbehaves.
>
> Proceed with passphrase-protected setup?

### If Unprotected Keys Exist

Proactively warn and offer:
```bash
ssh-keygen -p -f ~/.ssh/id_ed25519  # Add passphrase to existing key
```

### Reference Commands

```bash
ssh-keygen -t ed25519 -C "email"    # New SSH key — SET A PASSPHRASE
gpg --full-generate-key             # New GPG key — passphrase required by default
eval "$(ssh-agent -s)" && ssh-add   # Cache passphrase for session
```

### Prohibited

| Action | Reason |
|--------|--------|
| Execute key ops without warning first | User must make informed decision |
| Ask user to share passphrase in chat | Passphrases go to system prompts, never agents |
| Store passphrases in files/env vars | Defeats protection entirely |
| Suggest skipping passphrase | Never trade security for convenience here |
| Pipe passphrase to `ssh-add` via stdin | Never automate away human approval |

---

## Constraints

1. **Storage**: Workspace data persists in `${WORKSPACE_PATH}`
2. **Network**: Container has full internet access
3. **Permissions**: Running as non-root user `abc` (sudo available)
4. **Docker**: Docker-in-Docker available if socket is mounted
